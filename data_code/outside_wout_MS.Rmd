---
title: "KAQI - Indoor Sensors - 2020"
author: "Owen O'Connor"
date: "Nov 1 2021"
output: word_document
---

## KAQI - Outdoor Sensors - 2020
### Eggs


Key:
Julie Noble:  House 1
Lorraine:     House 2


Loading needed packages, reading in csv files, and taking a peek at what was loaded in:
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(feather)
library(wesanderson)
library(PerformanceAnalytics)
library(openair)


jn_out_2020 <- read_csv("jn_out_2020.csv",col_types = "Tcdddddddddddddddddddd")
lorraine_out_2020 <- read_csv("lorraine_out_2020.csv",col_types = "Tcdddddddddddddddddddd")




glimpse(jn_out_2020) 
glimpse(lorraine_out_2020) 

```
Renaming variables, selecting certain variables we want, and doing a basic plot to check the period that the data covers:


```{r}

jn_out_2020 <- jn_out_2020 %>% 
    rename(
    temp = `temperature[degC]`,
    RH = `humidity[percent]`,
    pressure = `pressure[Pa]`,
    pm10p0 = `pm10p0[ug/m^3]`,
    pm2p5 = `pm2p5[ug/m^3]`
  ) %>%
  select(
    time, temp, RH, pressure, pm10p0,  pm2p5
  ) %>%
  filter(
    time >= ymd_hms("2020-04-08 00:00:00")
  )

jn_out_2020 %>% 
  rename(
    date = time
  ) %>%
  summaryPlot(period = "months")
```

```{r}
lorraine_out_2020 <- lorraine_out_2020 %>% 
    rename(
    temp = `temperature[degC]`,
    RH = `humidity[percent]`,
    pressure = `pressure[Pa]`,
    pm10p0 = `pm10p0[ug/m^3]`,
    pm2p5 = `pm2p5[ug/m^3]`
  ) %>%
  select(
    time, temp, RH, pressure, pm10p0,  pm2p5
  ) %>%
  filter(
    time >= ymd_hms("2020-03-27 00:00:00")
  )

lorraine_out_2020 %>% 
  rename(
    date = time
  ) %>%
  summaryPlot(period = "months")
```



Basic time series plot to get a better sense of each house's PM2.5 measurements:
```{r}
#Time Series plot
ggplot(jn_out_2020, aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "red", alpha =.4) +
  theme_classic() +
  labs(
    y = expression(PM2.5 - (μg/~m^3)),
    x = NULL,
    title = "House 1 PM2.5",
    subtitle = paste(
      "2020 - Outdoors"
    )) +
    theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
#scale_y_continuous(limits = c(0,50))
```
```{r}
#Time Series plot
ggplot(lorraine_out_2020, aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "blue", alpha =.4) +
  theme_classic() +
  labs(
    y = expression(PM2.5 - (μg/~m^3)),
    x = NULL,
title = "House 2 PM2.5",
    subtitle = paste(
      "2020 -Outdoors"
    )) +
    theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
#scale_y_continuous(limits = c(0,50))
```




### Combine and Compare
We condense measurements to hourly averages:

```{r}

# Make all outdoor sets hourly averages
jn_out_2020 <- jn_out_2020 %>%
  group_by(time = cut(time, breaks="1 hour")) %>%
  summarize(
    temp = mean(temp, na.rm = TRUE),
    RH = mean(RH,na.rm = TRUE),
    pressure = mean(pressure, na.rm = TRUE),
    pm10p0 = mean(pm10p0,na.rm = TRUE),
    pm2p5 = mean(pm2p5,na.rm = TRUE)
            ) %>%
  mutate(
    time = ymd_hms(time)
  )


lorraine_out_2020 <- lorraine_out_2020 %>%
  group_by(time = cut(time, breaks="1 hour")) %>%
  summarize(
    temp = mean(temp, na.rm = TRUE),
    RH = mean(RH,na.rm = TRUE),
    pressure = mean(pressure, na.rm = TRUE),
    pm10p0 = mean(pm10p0,na.rm = TRUE),
    pm2p5 = mean(pm2p5,na.rm = TRUE)
            ) %>%
  mutate(
    time = ymd_hms(time)
  )


```


Then we join all the datasets by the time:
```{r}
outdoor_2020 <- inner_join(jn_out_2020, lorraine_out_2020,by="time", suffix = c(".house1",".house2")) 



```

Plots comparing the houses:

```{r}
 #preparing data for boxplots
 bout_2020 <- gather(outdoor_2020,`Sensor`, pm2.5,c(pm2p5.house1, pm2p5.house2))

 ggplot(bout_2020,aes(x=`Sensor`,pm2.5, fill = `Sensor`)) +
   geom_boxplot(outlier.shape = NA) +
   stat_boxplot(geom = "errorbar") +
   #stat_summary(fun=mean, geom="point", shape=20, size=3, color="yellow") +
   labs(
     y = expression(PM2.5 - (μg/~m^3)),
     x = NULL,
     title = paste(
       "Outdoor Sensors, 2020"
     ),
    subtitle = paste(
       "without outliers"
     )) +
   scale_fill_manual(labels = c("House 1","House 2"),values=wes_palette(n=2, name = "Darjeeling1")) +
   scale_y_continuous(limits = c(0,25)) +
   theme_classic() +
   theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r}
ggplot(bout_2020,aes(x=`Sensor`,pm2.5, fill = `Sensor`)) +
   geom_boxplot() +
   stat_boxplot(geom = "errorbar") +
   stat_summary(fun=mean, geom="point", shape=20, size=3, color="yellow") +
   labs(
     y = expression(PM2.5 - (μg/~m^3)),
     x = NULL,
     title = paste(
       "Outdoor Sensors, 2020"
     ),
    subtitle = paste(
       "with outliers"
     )) +
   scale_fill_manual(labels = c("House 1","House 2"),values=wes_palette(n=2, name = "Darjeeling1")) +
   #scale_y_continuous(limits = c(0,25)) +
   theme_classic() +
   theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r}
#Time Series plot w all two
ggplot(bout_2020,aes(x=time, pm2.5, fill = `Sensor`)) +
  geom_point(aes(color = `Sensor`), size = .6, alpha =.4) +
  #geom_smooth(aes(color = `Sensor`), se = FALSE) +
  theme_classic() +
  labs(
    y = expression(PM2.5 - (μg/~m^3)),
    x = NULL,
    title = paste(
      "Outdoor Sensors"
    ),
    subtitle = paste(
      "2020"
    )) +
    theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
#scale_y_continuous(limits = c(0,50))
```
Can't see too much plotting the whole period together. Here's a zoom in on a week in May:

```{r}
#Time Series plot w both - May
ggplot(subset(bout_2020, month(time) == 5 & day(time) > 1 & day(time) < 10), aes(x=time, pm2.5, fill = `Sensor`)) +
  geom_point(aes(color = `Sensor`), size = .6, alpha =.4) +
  #geom_smooth(aes(color = `Sensor`), se = FALSE) +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
    title = paste(
      "Outdoor Sensors"
    ),
    subtitle = paste(
      "Selection, May 2020"
    )) +
    theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
#scale_y_continuous(limits = c(0,50))
```
```{r}
#Time Series plot w both - Nov
ggplot(subset(bout_2020, month(time) == 11 & day(time) > 10 & day(time) < 20), aes(x=time, pm2.5, fill = `Sensor`)) +
  geom_point(aes(color = `Sensor`), size = .6, alpha =.4) +
  #geom_smooth(aes(color = `Sensor`), se = FALSE) +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
    title = paste(
      "Outdoor Sensors"
    ),
    subtitle = paste(
      "Selection, Nov 2020"
    )) +
    theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.subtitle = element_text(hjust = 0.5))
#scale_y_continuous(limits = c(0,50))
```


Testing of differences in means. I'm using these two tests because the PM2.5 doesn't look like it's normally distributed (just based on the histograms):

```{r}
library(rstatix)
kruskal <- kruskal_test(`pm2.5` ~`Sensor`,data=bout_2020)
kruskal
```


```{r}
wilcox <- pairwise.wilcox.test(bindoor_2020$pm2.5, bout_2020$Sensor,
                 p.adjust.method = "bonferroni")
wilcox
```


Let's just Zoom in on Julie's data for a minute to look at the midnight situation some more:

Here's Julie's Outdoor sensor in Jun 2020.
```{r}
#Time Series plot
ggplot(subset(jn_out_2020, month(time) == 6 & day(time) > 1 & day(time) < 10), aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "red", alpha =.4) +
  scale_x_datetime(minor_breaks = NULL, date_breaks = "6 hours", date_labels = "%l %p") +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
       title = "House 1 Outdoor Sensor",
    subtitle = paste(
      "Selection from June 2020"
    )) +
theme(
    axis.text.x=element_text(angle=60, hjust=1),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5), 
    text = element_text(family = "Helvetica")
)
    
```

We're not seeing the same weird pattern in the outdoor sensor at Julie's


Here's what Lorraine's looks like from the same period.
```{r}
#Time Series plot
ggplot(subset(lorraine_out_2020, month(time) == 6 & day(time) > 1 & day(time) < 10), aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "blue", alpha =.4) +
  scale_x_datetime(minor_breaks = NULL, date_breaks = "6 hours", date_labels = "%l %p") +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
       title = "House 2 Outdoor Sensor",
    subtitle = paste(
      "Selection from June 2020"
    )) +
theme(
    axis.text.x=element_text(angle=60, hjust=1),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5), 
    text = element_text(family = "Helvetica")
)
#scale_y_continuous(limits = c(0,50))
```


Let's look at a few burn periods:

```{r}
#Time Series plot
ggplot(subset(lorraine_out_2020, month(time) == 5 & day(time) > 15 & day(time) < 17), aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "blue", alpha =.4) +
  scale_x_datetime(minor_breaks = NULL, date_breaks = "6 hours", date_labels = "%l %p") +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
       title = "House 2 Outdoor Sensor",
    subtitle = paste(
      ""
    )) +
theme(
    axis.text.x=element_text(angle=60, hjust=1),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5), 
    text = element_text(family = "Helvetica")
)
#scale_y_continuous(limits = c(0,50))
```

```{r}
#Time Series plot
ggplot(subset(lorraine_out_2020, month(time) == 5 & day(time) > 21 & day(time) < 23), aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "blue", alpha =.4) +
  scale_x_datetime(minor_breaks = NULL, date_breaks = "6 hours", date_labels = "%l %p") +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
       title = "House 2 Outdoor Sensor",
    subtitle = paste(
      ""
    )) +
theme(
    axis.text.x=element_text(angle=60, hjust=1),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5), 
    text = element_text(family = "Helvetica")
)
#scale_y_continuous(limits = c(0,50))
```

```{r}
#Time Series plot
ggplot(subset(lorraine_out_2020, month(time) == 10 & day(time) > 17 & day(time) < 20), aes(time,y)) +
  geom_point(aes(y = pm2p5), size= .3, color = "blue", alpha =.4) +
  scale_x_datetime(minor_breaks = NULL, date_breaks = "6 hours", date_labels = "%l %p") +
  theme_classic() +
  labs(
    y = "pm2.5",
    x = NULL,
       title = "House 2 Outdoor Sensor",
    subtitle = paste(
      ""
    )) +
theme(
    axis.text.x=element_text(angle=60, hjust=1),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5), 
    text = element_text(family = "Helvetica")
)
#scale_y_continuous(limits = c(0,50))
```
```{r}
outdoor_2020 %>%
  select(
    pm2p5.house1,
    pm2p5.house2,

  ) %>% 
chart.Correlation()
```
